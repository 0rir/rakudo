
@bpv(BLIB_DIR)@ = @js_blib@
@bpv(BLIB)@ = @bpm(BLIB_DIR)@
#@bpv(BUILD_DIR)@ = @js_build_dir@
#@bpv(RUNNER)@ = @perl6_js_runner@
@bpv(NQP)@ = @js_nqp@
@bpv(RUNTIME)@ = @nqp::libdir@@nfp(/nqp-js-on-js/node_modules/nqp-runtime)@
@bpv(NQP_BASE_FLAGS)@ = --nqp-runtime @bpm(RUNTIME)@ --perl6-runtime @perl6_runtime@ --libpath "@perl6_lowlevel_libs@|||@nqp::libdir@@nfp(/nqp-js-on-js/)@"
@bpv(NQP_FLAGS)@ = @bpm(NQP_BASE_FLAGS)@ --substagestats --stagestats --source-map
@bpv(NQP_FLAGS_EXTRA)@ = --execname @bpm(RUNNER)@ --shebang
@bpv(RUN_PERL6)@ = node --max-old-space-size=8192 perl6.js @bpm(NQP_BASE_FLAGS)@ --source-map

@bpv(CLEANUPS)@ = \
	perl6.js \
	@bpm(BLIB_DIR)@/load-compiler.js

@include(Makefile-backend-common)@

# files we create

#rakudo.js: @nfp(@bpm(BUILD_DIR)@/perl6.nqp)@ @bsm(PERL6_G)@ @bsm(PERL6_A)@ @bsm(PERL6_C)@ @bsm(PERL6_P)@
#	@echo '+++ Composing\t$@'
#	@noecho@@bpm(NQP)@ @bpm(BASE_FLAGS)@ --execname $(JS_RUNNER) --substagestats --stagestats --target=js --source-map --shebang --output=rakudo.js @nfp($(JS_BUILD_DIR)/main.nqp)@

@nfp(@bpm(BUILD_DIR)@/load-compiler.nqp)@: @nfp(src/vm/js/load-compiler.nqp)@
@nfp(@bpm(BLIB_DIR)@/load-compiler.js)@:   @nfp(@bpm(BUILD_DIR)@/load-compiler.nqp)@ @bsm(PERL6_G)@ @bsm(PERL6_A)@ @bsm(PERL6_C)@ @bsm(PERL6_P)@

#@nfp($(JS_BLIB)/load-compiler.js)@: @nfp(src/vm/js/load-compiler.nqp)@ $(PERL6_G_JS) $(PERL6_A_JS) $(PERL6_C_JS) $(PERL6_P_JS)
#	$(MKPATH) $(JS_BLIB)
#	$(JS_NQP) $(JS_FLAGS)  --substagestats --stagestats --target=js --source-map  --output=@nfp($(JS_BLIB)/load-compiler.js)@ @nfp(src/vm/js/load-compiler.nqp)@

$(JS_RUNNER):
	$(PERL5) @script(create-js-runner.pl)@

#@for_specs($(PERL6_BOOTSTRAP_@ucspec@_JS): $(JS_BOOTSTRAP_@ucspec@_SOURCES) $(PERL6_M_JS)
#	$(MKPATH) @nfp($(JS_BLIB)/Perl6/BOOTSTRAP)@
#	$(JS_NQP) @script(gen-cat.nqp)@ js $(JS_BOOTSTRAP_@ucspec@_SOURCES) > @nfpq($(JS_BUILD_DIR)/Perl6-BOOTSTRAP.@lcspec@.nqp)@
#	$(JS_NQP) $(JS_FLAGS)  --substagestats --stagestats --target=js --source-map  --output=$(PERL6_BOOTSTRAP_@ucspec@_JS) @nfpq($(JS_BUILD_DIR)/Perl6-BOOTSTRAP.@lcspec@.nqp)@
#
#$(SETTING_@ucspec@_JS): $(PERL6_MOAR) $(PERL6_BOOTSTRAP_@ucspec@_JS) $(JS_CORE_ALL_SOURCES)
#	$(CONFIGURE) --expand @shquot(@ctx_template(core_sources)@)@ \
#			 --out @nfpq($(JS_BUILD_DIR)/core_sources.@lcspec@)@ \
#			 --set-var=backend=@backend@
#	$(JS_NQP) @script(gen-cat.nqp)@ js -f @nfpq($(JS_BUILD_DIR)/core_sources.@lcspec@)@ > @nfpq($(JS_BUILD_DIR)/CORE.@lcspec@.setting)@
#	@echo "The following step can take a long time, please be patient."
#	node --max-old-space-size=8192 rakudo.js $(JS_FLAGS) --source-map --target=js --setting=NULL.@lcspec@ --output=@nfp($(JS_BLIB)/CORE.@lcspec@.setting.js)@ @nfp($(JS_BUILD_DIR)/CORE.@lcspec@.setting)@
#
#)@



#js-all: check_nqp_version @nfp($(JS_BUILD_DIR)/ModuleLoader.nqp)@ $(PERL6_G_JS) $(PERL6_A_JS) $(PERL6_C_JS) $(PERL6_P_JS) rakudo.js @for_specs($(JS_BLIB)/CORE.@lcspec@.setting.js )@ $(JS_RUNNER) $(JS_BLIB)/load-compiler.js
#TODO cleanup BOOTSTRAP
js-clean:
	$(RM_F) @bpm(CLEANUPS_ALL)@
	#$(RM_F) @nfp(@bpm(BUILD_DIR)@/ModuleLoader.nqp)@ perl6.js BLIB)/CORE.setting.js $(JS_BUILD_DIR)/CORE.setting $(JS_BUILD_DIR)/ModuleLoader.nqp $(PERL6_ML_JS) $(JS_BUILD_DIR)/Perl6-Ops.nqp $(PERL6_OPS_JS) $(PERL6_P_JS) $(PERL6_W_JS) $(JS_BUILD_DIR)/Perl6-Actions.nqp $(PERL6_A_JS) $(PERL6_G_JS) $(JS_BUILD_DIR)/Perl6-Optimizer.nqp $(PERL6_O_JS) $(PERL6_C_JS) $(JS_BUILD_DIR)/main-version.nqp $(JS_BUILD_DIR)/main.nqp rakudo.js $(JS_BLIB)/load-compiler.js $(JS_BUILD_DIR)/Metamodel.nqp  $(PERL6_M_JS)

js-lint:
	gjslint --strict --max_line_length=200 --nojsdoc @nfp(src/vm/js/perl6-runtime/*.js)@

#js-testable: js-all spectest_checkout spectest_update

js-spectest: js-testable
	$(PERL5) t/harness5 --fudge --js --keep-exit-code --tests-from-file=@nfp(t/spectest.js.data)@

js-install: js-all
	@echo "Installing the js backend is not yet implemented."

js-runner-default:

# vim: ft=make noexpandtab ts=4 sw=4
