<html>
<head>
    <title>Rakudo architectural overview</title>
</head>
<body style="margin:2ex">

<h1>Rakudo architectural overview</h1>

<object 
    style="margin:2ex; float:left"
    data="architecture.svg"
    type="image/svg+xml"
    alt="Rakudo flow chart"
    >
    </object>

<a id="action-methods" />
<h2 id="parser" >Parser and Action methods</h2>

<p>The Perl 6 source code is transformed in various stages. The first are the Parser and Action Method stage. This stage creates a parse tree out of the Perl 6 source code and the fires off Action methods that annotate the parse tree, incrementally turning it into an Abstract Syntax Tree (QAST). When an Action Method is done annotating, the control is handed back to the Parser, which then continues parsing the Perl 6 code.</p>

<p>The result of these two stages is an "improved PAST" (Perl 6 Abstract Syntax Tree) named QAST. This tree is then passed on to the QAST compiler.</p>

<p>The Parser and Action methods are implemented in "Not Quite Perl 6" (NQP) and are part of Rakudo and hosted in the Rakudo repository at <a href="../src/Perl6/Grammar.pm">src/Perl6/Grammar.pm</a> and <a href="../src/Perl6/Actions.pm">src/Perl6/Actions.pm</a>.</p>

<h2 id="QAST-compiler">QAST compiler</h2>

<p>The QAST compiler transforms the abstract syntax tree into a PIRT (Parrot Intermediate Representation Tree). In this phase we have the program represented as an AST, and need to translate this into the PIR that the Parrot VM understands. To do this, the QAST compiler does a series of translations on the AST, creating PIRT nodes that implement the operations specified by the QAST nodes.</p>

<p>In addition, the QAST compiler is responsible for serializing The World in such a way that the later stages can get access to the declarations stored there during the Parser and Action methods stages.</p>

<p>There's also opportunity to apply some VM-specific optimizations at this point. When this is done, the resulting PIRT is passed to the PIRT serializer.</p>

<p>This stage is described in <a href="../nqp/src/QAST/">nqp/src/QAST/</a>.</p>

<h2 id="The-World">The World</h2>

<p>The World is where the parser and the action methods store any declarations they encouter during their runs.</p>


<h2 id="PIRT-serializer">PIRT serializer</h2>

<p>The PIRT serializer "squashes" the PIR tree into a format that can be passed to Parrot itself and it's IMCC (InterMediate Code Compiler) stage.</p>

<p>You can read more about this at <a href="../nqp/src/QAST/PIRT.nqp">nqp/src/QAST/PIRT.nqp</a></p>


<a id="parrot-runtime" />
<h2 id="imcc">IMCC and Parrot runtime</h2>

<p>The IMCC (InterMediate Code Compiler) receives the PIR code from the PIRT serializer and then transforms it into Parrot Byte Code (PBC). IMCC is parrot's PIR compiler, written in C and statically linked into parrot. The byte code can then be stored to disk or executed in memory by one of the <em>run cores</em> availabe as part of the Parrot runtime. This is in some sense the heart of Parrot - or one of the hearts; There are several different cores available, includin one for just-in-time compilation (JIT), one for debugging and more.</p>

<p>You can find out more about this on <a href="../parrot/docs/imcc">parrot/docs/imcc/</a></p>

<h2 id="pmc-dynops">PMCs and dynops</h2>

<p>There are also some supporting custom types and operations in Rakudo called <em>dynamic PMCs</em> and <em>dynamic ops</em> (dynops) which are written in C, and helper functions written in NQP and PIR. These supporting libraries exist for adding features to Parrot that are needed to handle special features in Perl 6.</p>

<h2 id="setting">Core setting library</h2>

<p>The part of Rakudo described so far is the <em>stage one</em> compiler. In the build process it is compiled first, and then it compiles the <em>Core setting library</em> down to PBC. "Core setting library" is a fancy term describing the built-in functions which are written in PerlÂ 6, whose purpose is to be the Perl 6 standard library. The result of this compilation is linked together with the stage one compiler and Parrot, the result is the <code>perl6</code> executable.</p>

<p>The core setting library informs the Parser and Action methods when compiling a Perl 6 program.</p>

<h2 id="glossary">Glossary</h2>

<dl>
    <dt>NQP</dt>
    <dd>Not Quite Perl 6, a small subset of Perl 6 that is used for tree transformations in compilers.</dd>

    <dt>PIR</dt>
    <dd>Parrot Intermediate Representation, the most commonly used for of parrot assembly (which is still high-level enough to be written by humans).</dd>

    <dt>IMCC</dt>
    <dd>InterMediate Code Compiler, the part of parrot that compiles PIR into byte code.</dd>

    <dt>PBC</dt>
    <dd>Parrot Byte Code, the binary form to which all parrot programs are compiled in the end.</dd>

    <dt>Core setting</dt>
    <dd>The core setting is the Perl 6 standard library.</dd>

    <dt>QAST</dt>
    <dd></dd>

    <dt>JIT</dt>
    <dd></dd>

    <dt>PIRT</dt>
    <dd></dd>

</dl>

</body>
</html>
<!-- 
    vim: ft=html spell sw=4 ts=4 expandtab tw=75
-->
